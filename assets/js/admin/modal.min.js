var BookDB_Modal_Admin={activeEditorID:false,newButExistingBook:false,shortcodeEscapeMap:{'"':"'"},disableMenu:function(){jQuery(".bookdb-frame-menu").find(".bookdb-menu-item").hide()},openModal:function(editor_id,args){args=args===undefined?{}:args;jQuery(".bookdb-button-action").text(bookdb_modal.l10n.action_button_default).show();jQuery(".bookdb-menu-item").show();BookDB_Modal_Admin.activeEditorID=editor_id;jQuery(".bookdb-modal-container").show();var tabs=jQuery(".bookdb-router").find(".bookdb-menu-item");jQuery(tabs).each(function(){var init_callback=jQuery(this).data("init");if(init_callback&&typeof BookDB_Modal_Admin[init_callback]=="function"){BookDB_Modal_Admin[init_callback](args)}});jQuery(".bookdb-menu").find(".bookdb-menu-item").first().click()},closeModal:function(){BookDB_Modal_Admin.activeEditorID=false;jQuery(".bookdb-menu").removeClass("visible");jQuery(".bookdb-modal-container").hide()},shortcodeEscape:function(text){return String(text).replace(/["]/g,function(s){return BookDB_Modal_Admin.shortcodeEscapeMap[s]})},addToEditor:function(text){text=" "+text+" ";if(BookDB_Modal_Admin.activeEditorID){if(typeof tinyMCE=="undefined"||!tinyMCE.get(BookDB_Modal_Admin.activeEditorID)||tinyMCE.get(BookDB_Modal_Admin.activeEditorID).isHidden()){var current=jQuery("textarea#"+BookDB_Modal_Admin.activeEditorID).val();jQuery("textarea#"+BookDB_Modal_Admin.activeEditorID).val(current+text)}else{tinyMCE.get(BookDB_Modal_Admin.activeEditorID).focus(true);tinyMCE.activeEditor.execCommand("mceInsertContent",false,text)}}},startLoader:function(button){button.prop("disabled",true).css("width",button.outerWidth()).data("text",button.html()).html("...")},stopLoader:function(button){button.prop("disabled",false).css("width","").html(button.data("text"))},editingBook:0,setBook:function(args){this.editingBook=args.bookID?args.bookID:0;this.clearBookFields();if(0!==this.editingBook){var button=jQuery(".bookdb-button-action");button.text(bookdb_modal.l10n.action_button_update);this.disableMenu();var data={action:"bdb_get_book",nonce:bookdb_modal.nonce,book_id:this.editingBook};this.startLoader(button);jQuery.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){console.log(response);BookDB_Modal_Admin.stopLoader(button);if(response.success){BookDB_Modal_Admin.setBookFields(response.data)}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})}},clearBookFields:function(){this.newButExistingBook=false;jQuery("#bookdb-existing-book-results").empty();jQuery(".bookdb-book-details-form > h3").text(bookdb_modal.l10n.insert_new_book);var wrap=jQuery(".bookdb-frame-content");wrap.find("input, textarea").each(function(){var self=jQuery(this);if("submit"==self.attr("type")||"button"==self.attr("type")){return true}self.val("")});jQuery("#bookdb-cover-image").attr("src","").hide();jQuery(".bookdb-remove-image").hide()},setBookFields:function(book){jQuery(".bookdb-book-details-form > h3").text(bookdb_modal.l10n.editing+'"'+book.title+'"');if(book.cover_id&&0!=book.cover_id){jQuery("#book_cover_id").val(book.cover_id);jQuery(".bookdb-remove-image").show()}if(book.cover_url){jQuery("#bookdb-cover-image").attr("src",book.cover_url).show()}if(book.title){jQuery("#book_title").val(book.title)}if(book.series_name){jQuery("#book_series_name").val(book.series_name)}if(book.series_position){jQuery("#book_series_position").val(book.series_position)}if(book.pub_date){jQuery("#book_pub_date").val(book.pub_date)}if(book.synopsis){jQuery("#book_synopsis").val(book.synopsis)}},insert_update_book:function(button){var book={ID:this.editingBook,cover:jQuery("#book_cover_id").val(),title:jQuery("#book_title").val(),series_name:jQuery("#book_series_name").val(),series_position:jQuery("#book_series_position").val(),pub_date:jQuery("#book_pub_date").val(),synopsis:jQuery("#book_synopsis").val()};var seriesID=jQuery("#series_id");if(seriesID.length){book.series_id=seriesID.val()}var data={action:"bdb_save_book",nonce:bookdb_modal.nonce,book:book};this.startLoader(button);jQuery.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){BookDB_Modal_Admin.stopLoader(button);if(response.success){if(0===BookDB_Modal_Admin.editingBook||true==BookDB_Modal_Admin.newButExistingBook){BookDB_Modal_Admin.addToEditor('[book id="'+response.data+'"]')}else{if(typeof tinyMCE!=="undefined"&&tinyMCE.get(BookDB_Modal_Admin.activeEditorID)&&!tinyMCE.get(BookDB_Modal_Admin.activeEditorID).isHidden()){tinyMCE.get(BookDB_Modal_Admin.activeEditorID).focus(true);tinyMCE.activeEditor.setContent(tinyMCE.activeEditor.getContent())}}BookDB_Modal_Admin.closeModal()}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})}};jQuery(document).ready(function($){var BookDB_Modal={init:function(){$(document).on("click",".bookdb-modal-button",this.openModal);$(".bookdb-modal-container").on("click",".bookdb-modal-close, .bookdb-modal-backdrop",BookDB_Modal_Admin.closeModal).on("click","bookdb-frame-title",this.mobileMenu);$(".bookdb-menu").on("click",".bookdb-menu-item",this.menu);$(".bookdb-router").on("click",".bookdb-menu-item",this.modalTabs);$(".bookdb-button-action").on("click",this.buttonCallback);$("#bookdb-search-existing-book").on("click",this.searchExistingBook)},openModal:function(e){var editor_id=$(this).data("editor");BookDB_Modal_Admin.openModal(editor_id)},menu:function(){var menu_item=$(this),menu_target=menu_item.data("menu"),menu_tab=menu_item.data("tab"),menu=$(".bookdb-menu");menu.removeClass("visible");menu.find(".bookdb-menu-item").removeClass("active");menu_item.addClass("active");$(".bookdb-frame-router").find(".bookdb-router").removeClass("active");$(".bookdb-frame-router").find("#bookdb-menu-"+menu_target).addClass("active");var active_tab=false;$(".bookdb-router").find(".bookdb-menu-item").removeClass("active");$(".bookdb-frame-router").find("#bookdb-menu-"+menu_target).find(".bookdb-menu-item").each(function(index){if(index===0||$(this).data("tab")==menu_tab){active_tab=$(this)}});if(active_tab){active_tab.click()}$(".bookdb-frame-title").find("h1").text(menu_item.text())},mobileMenu:function(){$(".book-db-menu").toggleClass("visible")},modalTabs:function(e){e.preventDefault();var menu_item=$(this),tab_target=menu_item.data("tab"),frameContent=$(".bookdb-frame-content");$(".bookdb-router").find(".bookdb-menu-item").removeClass("active");menu_item.addClass("active");if(menu_item.data("callback")){$(".bookdb-button-action").show()}else{$(".bookdb-button-action").hide()}frameContent.find(".bookdb-frame-content-tab").removeClass("active");frameContent.find("#bookdb-tab-"+tab_target).addClass("active")},buttonCallback:function(){var active_tab=$(".bookdb-router.active").find(".bookdb-menu-item.active"),callback=active_tab.data("callback");if(typeof BookDB_Modal_Admin[callback]=="function"){BookDB_Modal_Admin[callback]($(this))}},searchExistingBook:function(e){e.preventDefault();var button=$(this),resultsWrap=$("#bookdb-existing-book-results");button.attr("disabled",true);resultsWrap.empty().append('<span class="spinner is-active"></span>');var data={action:"bdb_search_book",nonce:bookdb_modal.nonce,search:$("#bookdb-search-existing").val(),field:$("#bookdb-search-field").val()};jQuery.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);resultsWrap.empty().append(response.data);if(response.success){resultsWrap.on("click","a",function(){BookDB_Modal_Admin.setBook({bookID:$(this).data("id")});BookDB_Modal_Admin.newButExistingBook=true})}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})}};BookDB_Modal.init()});