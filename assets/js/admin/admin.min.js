(function($){var Book_Database={init:function(){this.sort();this.clone();$(document).on("click",".bookdb-book-option-toggle",this.toggleBookTextarea);$(document).on("change","#bookdb-book-layout-cover-changer",this.changeCoverAlignment);$(".bookdb-new-checkbox-term").on("click",".button",this.addCheckboxTerm);$(".bookdb-new-checkbox-term .bookdb-new-checkbox-term-value").keypress(this.addCheckboxTerm);$("#bookdb-add-review").on("click",this.toggleAddReviewFields);$("#bookdb-add-review-search-book-input").keypress(this.searchForBookToReview);$("#bookdb-add-review-search-for-book").on("click","button",this.searchForBookToReview);$("#bookdb-add-review-fields-wrap").on("click","button",this.addReview);$("#bdb_book_reviews").on("click",".bookdb-remove-book-review",this.removeReview);$("#index_title").on("change",this.toggleCustomIndexTitle);$("#book_title").on("keyup",this.writeOriginalIndexTitle).on("blur",this.populateAltTitles);$(document).ready(this.toggleCustomIndexTitle);$(document).on("click","#bookdb-add-owned-edition",this.toggleOwnedEditionFields);$(document).on("click","#bookdb-submit-owned-edition",this.submitOwnedEdition);$(document).on("click",".bookdb-edit-owned-edition",this.editOwnedEdition);$(document).on("click",".bookdb-delete-owned-edition",this.deleteOwnedEdition);$(document).on("click","#bookdb-read-book",this.toggleReadingListFields);$(document).on("click","#bookdb-submit-reading-entry",this.submitReadingEntry);$(document).on("click",".bookdb-edit-reading-entry",this.editReadingEntry);$(document).on("click",".bookdb-delete-reading-entry",this.deleteReadingEntry);$(document).ready(this.associateReadingLog);$(document).on("change","#insert_reading_log",this.associateReadingLog);$(document).on("click",".bdb-currently-reading-widget-update-progress",this.updateReadingProgress);$(document).on("click",".bdb-currently-reading-widget-finish-book",this.finishCurrentlyReadingBook)},sort:function(){$(".bookdb-sortable").sortable({cancel:".bookdb-no-sort, textarea, input, select",connectWith:".bookdb-sortable",placeholder:"bookdb-sortable-placeholder",update:function(event,ui){var currentItem=ui.item;var parentID=currentItem.parent().attr("id");var disabledIndicator=currentItem.find(".bookdb-book-option-disabled");if($("#"+parentID).hasClass("bookdb-sorter-enabled-column")){disabledIndicator.val("false")}else{disabledIndicator.val("true")}}}).enableSelection()},clone:function(){if($.isFunction($.fn.relCopy)){$("#bookdb-add-term").relCopy()}},toggleBookTextarea:function(e){$(this).next().slideToggle()},changeCoverAlignment:function(e){var parentDiv=$("#bookdb-book-option-cover");parentDiv.removeClass(function(index,css){return(css.match(/(^|\s)bookdb-book-cover-align-\S+/g)||[]).join(" ")});parentDiv.addClass("bookdb-book-cover-align-"+$(this).val())},addCheckboxTerm:function(e){if("click"==e.type){e.preventDefault()}if("keypress"==e.type&&13!=e.which){return true}else{e.preventDefault()}var wrap=$(this).parents(".bookdb-taxonomy-checkboxes"),checkboxName=wrap.data("name"),checkboxWrap=wrap.find(".bookdb-checkbox-wrap"),newTerm=wrap.find(".bookdb-new-checkbox-term-value");checkboxWrap.append('<label><input type="checkbox" name="'+checkboxName+'" class="bookdb-checkbox" value="'+newTerm.val()+'" checked="checked"> '+newTerm.val()+"</label>");newTerm.val("")},toggleAddReviewFields:function(e){e.preventDefault();$("#bookdb-add-review-fields").slideDown()},searchForBookToReview:function(e){if("click"==e.type){e.preventDefault()}if("keypress"==e.type&&13!=e.which){return true}else{e.preventDefault()}var button=$(this).parents("#bookdb-add-review-search-for-book").find("button"),searchWrap=button.parents("#bookdb-add-review-search-for-book"),searchFor=$("#bookdb-add-review-search-book-input").val(),searchField=$("#book-db-add-review-search-type").val(),resultsWrap=$("#bookdb-book-search-results"),bookID=$("#bookdb-book-to-add-review");button.attr("disabled",true);searchWrap.append('<span class="spinner is-active"></span>');bookID.val(0);var data={action:"bdb_search_book",nonce:book_database.nonce,search:searchFor,field:searchField};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);searchWrap.find(".spinner").remove();resultsWrap.empty().append(response.data).show();if(response.success){resultsWrap.on("click","a",function(e){e.preventDefault();$("#bookdb-add-review-search-book-input").val("");bookID.val($(this).data("id"));var data={action:"bdb_get_book_reading_logs",nonce:book_database.nonce,book_id:$(this).data("id")};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){console.log(response);if(response.success){var readingLog=$("#reading_log");readingLog.empty().append('<option value="">None</option>');$.each(response.data,function(key,value){readingLog.append('<option value="'+key+'">'+value+"</option>")})}else{if(window.console&&window.console.log){console.log(response)}}resultsWrap.hide();$("#bookdb-add-review-fields-wrap").show()}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})})}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},addReview:function(e){e.preventDefault();var button=$(this),wrap=$("#bookdb-add-review-fields-wrap"),book_id=$("#bookdb-book-to-add-review"),reading_log=$("#reading_log"),user_id=$("#review_user_id"),table=$("#bdb_book_reviews").find("table");button.attr("disabled",true);wrap.append('<span class="spinner is-active"></span>');var review={book_id:book_id.val(),reading_log:reading_log.val(),user_id:user_id.val(),post_id:$("#post_ID").val()};var data={action:"bdb_save_review",nonce:book_database.nonce,review:review};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);wrap.find(".spinner").remove();if(response.success){user_id.val(user_id.data("current"));$("#bookdb-no-book-reviews-message").remove();table.find("tbody").append('<tr data-id="'+response.data.ID+'"><td>'+response.data.ID+"</td><td>"+response.data.book+"</td><td>"+response.data.rating+"</td><td><code>"+response.data.shortcode+"</code></td><td>"+response.data.remove+"</td></tr>");wrap.hide()}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},removeReview:function(e){e.preventDefault();if(!confirm(book_database.l10n.review_remove)){return false}var button=$(this),wrap=$(this).parents("tr"),reviewID=wrap.data("id");if(typeof reviewID=="undefined"||!reviewID){alert(book_database.l10n.error_removing_review);return false}button.attr("disabled",true);button.parent().append('<span class="spinner is-active" style="float:none"></span>');var data={action:"bdb_remove_review",nonce:book_database.nonce,review_id:reviewID};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){if(response.success){wrap.remove()}else{if(window.console&&window.console.log){console.log(response)}}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},toggleCustomIndexTitle:function(e){var indexValue=$("#index_title").val();var customField=$("#index_title_custom");if("custom"==indexValue){customField.slideDown().css("display","block")}else{customField.slideUp()}},writeOriginalIndexTitle:function(e){$('#index_title option[value="original"]').text($(this).val())},populateAltTitles:function(e){var indexTitleSelect=$("#index_title");var data={action:"bdb_get_alt_titles",nonce:book_database.nonce,title:$(this).val()};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){if(response.success){indexTitleSelect.find('option[value="original"]').after('<option value="'+response.data+'">'+response.data+"</option>")}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},toggleOwnedEditionFields:function(e){e.preventDefault();$("#bookdb-owned-edition-fields").slideToggle()},submitOwnedEdition:function(e){e.preventDefault();var button=$(this);var wrap=$("#bookdb-owned-edition-fields");button.attr("disabled",true);var edition={book_id:wrap.data("book-id"),isbn:$("#owned_edition_isbn").val(),format:$("#owned_edition_format").val(),date_acquired:$("#owned_edition_date_acquired").val(),source:$("#bookdb-owned-edition-fields #dbd-checkboxes-source").find("input:checked").val(),signed:$("#owned_edition_signed:checked").length};var data={action:"bdb_save_owned_edition",nonce:book_database.nonce,edition:edition};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){$("#bookdb-no-owned-editions").remove();wrap.parents(".postbox").find("tbody").append(response.data);$("#bookdb-owned-edition-fields").slideUp()}else{console.log(response)}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},editOwnedEdition:function(e){e.preventDefault();var button=$(this);var wrap=$("#bookdb-owned-edition-fields");var tr=$(this).parents("tr");var editionID=tr.data("edition-id");var edition={};if(typeof editionID=="undefined"||editionID==""){return false}button.addClass("button-primary").text("Save");tr.find(".bookdb-owned-edition-display-value").hide();tr.find(".bookdb-owned-edition-edit-value").show();button.on("click",function(e){e.preventDefault();button.attr("disabled",true);var edition={ID:editionID,book_id:wrap.data("book-id"),isbn:tr.find(".bookdb-owned-edition-isbn input").val(),format:tr.find(".bookdb-owned-edition-format select").val(),date_acquired:tr.find(".bookdb-owned-edition-date-acquired input").val(),source:tr.find(".bookdb-owned-edition-source select").val(),signed:tr.find(".bookdb-owned-edition-signed input:checked").length};var data={action:"bdb_save_owned_edition",nonce:book_database.nonce,edition:edition};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){tr.replaceWith(response.data);$(".bookdb-edit-owned-edition").on("click",Book_Database.editOwnedEdition());$(".bookdb-delete-owned-edition").on("click",Book_Database.deleteOwnedEdition())}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})})},deleteOwnedEdition:function(e){e.preventDefault();if(!confirm(book_database.l10n.owned_edition_remove)){return false}var button=$(this);var tr=button.parents("tr");button.attr("disabled",true);var data={action:"bdb_delete_owned_edition",nonce:book_database.nonce,edition_id:tr.data("edition-id")};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){tr.remove()}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},toggleReadingListFields:function(e){e.preventDefault();$("#bookdb-read-book-fields").slideToggle()},submitReadingEntry:function(e){e.preventDefault();var button=$(this);var wrap=$("#bookdb-read-book-fields");button.attr("disabled",true);var entry={book_id:wrap.data("book-id"),date_started:$("#reading_start_date").val(),date_finished:$("#reading_end_date").val(),user_id:$("#reading_user_id").val(),review_id:$("#review_id").val(),complete:$("#percent_complete").val(),rating:$("#book_rating").val()};var data={action:"bdb_save_reading_entry",nonce:book_database.nonce,entry:entry};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){$("#bookdb-no-reading-log-entries").remove();wrap.parents(".postbox").find("tbody").append(response.data);$("#bookdb-read-book-fields").slideUp()}else{console.log(response)}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},editReadingEntry:function(e){e.preventDefault();var button=$(this);var wrap=$("#bookdb-read-book-fields");var tr=$(this).parents("tr");var entryID=tr.data("entry-id");var entry={};if(typeof entryID=="undefined"||entryID==""){return false}button.addClass("button-primary").text("Save");tr.find(".bookdb-reading-log-display-value").hide();tr.find(".bookdb-reading-log-edit-value").show();button.on("click",function(e){e.preventDefault();button.attr("disabled",true);var entry={ID:entryID,book_id:wrap.data("book-id"),date_started:tr.find(".bookdb-reading-log-date-started input").val(),date_finished:tr.find(".bookdb-reading-log-date-finished input").val(),user_id:tr.find(".bookdb-reading-log-user-id input").val(),review_id:tr.find(".bookdb-reading-log-review-id input").val(),complete:tr.find(".bookdb-reading-log-complete input").val(),rating:tr.find(".bookdb-reading-log-rating select").val()};var data={action:"bdb_save_reading_entry",nonce:book_database.nonce,entry:entry};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){tr.replaceWith(response.data);$(".bookdb-edit-reading-entry").on("click",Book_Database.editReadingEntry);$(".bookdb-delete-reading-entry").on("click",Book_Database.deleteReadingEntry)}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})})},deleteReadingEntry:function(e){e.preventDefault();if(!confirm(book_database.l10n.reading_entry_remove)){return false}var button=$(this);var tr=button.parents("tr");button.attr("disabled",true);var data={action:"bdb_delete_reading_entry",nonce:book_database.nonce,entry_id:tr.data("entry-id")};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){button.attr("disabled",false);if(response.success){tr.remove()}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})},associateReadingLog:function(e){var selected=$("#insert_reading_log").val();switch(selected){case"existing":$("#bookdb-review-existing-reading-log-fields").show();$("#bookdb-review-new-reading-log-fields").hide();break;case"create":$("#bookdb-review-existing-reading-log-fields").hide();$("#bookdb-review-new-reading-log-fields").show();break;default:$("#bookdb-review-existing-reading-log-fields").hide();$("#bookdb-review-new-reading-log-fields").hide();break}},updateReadingProgress:function(e){var entry_id=$(this).data("log");var percentage=prompt(book_database.l10n.enter_percentage);var progress_wrap=$(this).parent().find(".bdb-currently-reading-progress-bar");var progress_number=$(this).parent().find(".bdb-currently-reading-progress-number");if(percentage!=null){var data={action:"bdb_update_reading_log_percentage",nonce:book_database.nonce,entry_id:entry_id,percentage:percentage};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){if(response.success&&response.data.percentage){progress_wrap.css("width",percentage+"%");progress_number.text(percentage+"%")}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})}},finishCurrentlyReadingBook:function(e){var entry_id=$(this).data("log");if(confirm(book_database.l10n.finish_book)){var data={action:"bdb_finish_currently_reading",nonce:book_database.nonce,entry_id:entry_id};$.ajax({type:"POST",url:ajaxurl,data:data,dataType:"json",success:function(response){if(response.success&&response.data.redirect){window.location.href=response.data.redirect}}}).fail(function(response){if(window.console&&window.console.log){console.log(response)}})}}};Book_Database.init();var BookDB_Tags={init:function(){var self=this,ajaxtag=$(".bookdb-ajaxtag"),wrapper=ajaxtag.parents(".bookdb-tags-wrap");$(".bookdb-tags-wrap").each(function(){BookDB_Tags.quickClicks($(this))});$(".button",ajaxtag).click(function(){self.flushTags($(this).closest(".bookdb-tags-wrap"))});ajaxtag.each(function(){var newTag=$(".bookdb-new-tag",$(this));var type=$(this).parents(".bookdb-tags-wrap").data("type");newTag.keyup(function(e){if(e.which==13){BookDB_Tags.flushTags($(this).closest(".bookdb-tags-wrap"));return false}}).keypress(function(e){if(13==e.which){e.preventDefault();return false}}).suggest(ajaxurl+"?action=bdb_suggest_tags&type="+type)});$("#book_series_name").suggest(ajaxurl+"?action=bdb_suggest_series");$("#post, #bookdb-book-page-wrapper > form").submit(function(e){$(".bookdb-tags-wrap").each(function(){BookDB_Tags.flushTags(this,false,1)})});$(document).on("bdb_modal_before_insert_update_book",function(){$(".bookdb-tags-wrap").each(function(){BookDB_Tags.flushTags(this,false,1)})})},clean:function(tags){return tags.replace(/\s*,\s*/g,",").replace(/,+/g,",").replace(/[,\s]+$/,"").replace(/^[,\s]+/,"")},parseTags:function(el){var id=el.id,num=id.split("-check-num-")[1],tagbox=$(el).closest(".bookdb-tags-wrap"),thetags=tagbox.find("textarea"),current_tags=thetags.val().split(","),new_tags=[];delete current_tags[num];$.each(current_tags,function(key,val){val=$.trim(val);if(val){new_tags.push(val)}});thetags.val(this.clean(new_tags.join(",")));this.quickClicks(tagbox);return false},quickClicks:function(el){var thetags=$("textarea",el),tagchecklist=$(".bookdb-tags-checklist",el),id=$(el).attr("id"),current_tags,disabled;if(!thetags.length)return;disabled=thetags.prop("disabled");current_tags=thetags.val().split(",");tagchecklist.empty();$.each(current_tags,function(key,val){var span,xbutton;val=$.trim(val);if(!val)return;span=$("<span />").text(val);if(!disabled){xbutton=$('<a id="'+id+"-check-num-"+key+'" class="ntdelbutton">X</a>');xbutton.click(function(){BookDB_Tags.parseTags(this)});span.prepend("&nbsp;").prepend(xbutton)}tagchecklist.append(span)})},flushTags:function(el,a,f){a=a||false;var text,tags=$("textarea",el),newtag=$(".bookdb-new-tag",el),tagsval,newtags;text=a?$(a).text():newtag.val();tagsval=tags.val();newtags=tagsval?tagsval+","+text:text;newtags=this.clean(newtags);newtags=BookDB_Tags.uniqueArray(newtags.split(",")).join(",");tags.val(newtags);this.quickClicks(el);if(!a)newtag.val("");if("undefined"==typeof f)newtag.focus();return false},uniqueArray:function(array){var out=[];$.each(array,function(key,val){val=$.trim(val);if(val&&$.inArray(val,out)===-1){out.push(val)}});return out}};$(document).ready(function(){BookDB_Tags.init();$(document).on("bdb_modal_set_book_fields",function(){BookDB_Tags.init()})})})(jQuery);