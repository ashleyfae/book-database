(()=>{"use strict";function e(e){var t=bdbVars.is_admin?'<span class="spinner is-active"></span>':bdbVars.please_wait;e.prop("disabled",!0).data("text",e.text()).html(t)}function t(e){e.prop("disabled",!1).text(e.data("text"))}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"POST",n={method:r,url:bdbVars.api_base+"book-database/"+e,beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",bdbVars.api_nonce)},xhrFields:{withCredentials:!0},data:t};return new Promise((function(e,t){jQuery.ajax(n).success((function(t){e(t)})).error((function(e,r,n){var a=bdbVars.generic_erroc;void 0!==e.responseJSON?void 0!==(a=e.responseJSON).message&&(a=a.message):void 0!==e.message&&(a=e.message),t(a)}))}))}var n={init:function(){jQuery(".bdb-currently-reading-widget-update-progress").on("click",this.updatePercentage),jQuery(".bdb-currently-reading-progress-unit-choices").on("click","a",this.setUnit),jQuery(".bdb-currently-reading-widget-save-progress").on("click",this.saveProgress),jQuery(".bdb-currently-reading-set-progress-wrap").on("keydown","input",this.saveProgressOnEnter),jQuery(".bdb-currently-reading-widget-finish-book").on("click",this.finishBook),jQuery(".bdb-currently-reading-widget-dnf-book").on("click",this.dnfBook),jQuery(".bdb-currently-reading-widget-set-rating").on("click",this.setRating)},updatePercentage:function(e){e.preventDefault(),jQuery(this).closest("li").find(".bdb-currently-reading-set-progress-wrap").slideToggle()},setUnit:function(e){e.preventDefault();var t=jQuery(this).closest(".bdb-currently-reading-set-progress-wrap"),r=jQuery(this).data("unit");t.find(".bdb-currently-reading-progress-unit-choices a").removeClass("bdb-currently-reading-progress-unit-selected"),jQuery(this).addClass("bdb-currently-reading-progress-unit-selected"),"page"===r?(t.find(".bdb-currently-reading-unit-percentage-wrap").hide(),t.find(".bdb-currently-reading-unit-pages-wrap").show()):(t.find(".bdb-currently-reading-unit-percentage-wrap").show(),t.find(".bdb-currently-reading-unit-pages-wrap").hide())},saveProgress:function(n){n.preventDefault();var a,i=jQuery(this),o=i.closest("li"),s=o.data("log-id"),d=o.find(".bdb-currently-reading-progress-unit-selected").data("unit"),u=0,l=o.find(".bdb-currently-reading-progress-bar"),c=o.find(".bdb-currently-reading-progress-number");if(e(i),"page"===d){var b=o.find(".bdb-currently-reading-unit-page"),p=parseInt(b.data("max")),f=parseInt(b.val());p>0&&(u=f/p,a=Math.round(100*u))}else{var h=o.find(".bdb-currently-reading-unit-percentage");(a=parseFloat(h.val()))>0&&(u=a/100)}r("v1/reading-log/update/"+s,{percentage_complete:u},"POST").then((function(e){l.css("width",a+"%"),c.text(a+"%")})).catch((function(e){console.log(e)})).finally((function(){t(i),o.find(".bdb-currently-reading-set-progress-wrap").slideUp()}))},saveProgressOnEnter:function(e){13===e.keyCode&&(e.preventDefault(),jQuery(this).closest("li").find(".bdb-currently-reading-widget-save-progress").trigger("click"))},finishBook:function(n){if(n.preventDefault(),!confirm(bdbVars.confirm_finish_book))return!1;var a=jQuery(this);e(a);var i=a.closest("li"),o={percentage_complete:1,date_finished:i.data("now")};r("v1/reading-log/update/"+i.data("log-id"),o,"POST").then((function(e){i.find(".bdb-currently-reading-data").remove(),i.find(".bdb-currently-reading-rate-book").show()})).catch((function(e){console.log(e)})).finally((function(){t(a)}))},dnfBook:function(n){if(n.preventDefault(),!confirm(bdbVars.confirm_dnf_book))return!1;var a=jQuery(this);e(a);var i=a.closest("li"),o={date_finished:i.data("now")};r("v1/reading-log/update/"+i.data("log-id"),o,"POST").then((function(e){i.find(".bdb-currently-reading-data").remove(),i.find(".bdb-currently-reading-rate-book").show()})).catch((function(e){console.log(e)})).finally((function(){t(a)}))},setRating:function(n){n.preventDefault();var a=jQuery(this);e(a);var i=a.closest("li"),o={rating:i.find(".bdb-currently-reading-rating").val()};r("v1/reading-log/update/"+i.data("log-id"),o,"POST").then((function(e){var t,r,n,a;i.find(".bdb-currently-reading-rate-book").empty().append("<p>"+(t=o.rating,r="",n=Math.floor(t),a=Math.ceil(t-n),(r+="&starf;".repeat(n))+"&half;".repeat(a)+"</p>"))})).catch((function(e){console.log(e)})).finally((function(){t(a)}))}},a="YYYY-MM-DD HH:mm:ss",i="MMMM D, YYYY";function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"mysql";if(""===e||!e)return"";t="display"===t?i:a;var r=(e=moment.utc(e)).local().format(t);return r}var s={postID:0,userID:0,bookID:0,table:!1,tableBody:!1,errorWrap:!1,searchResultsWrap:!1,init:function(){document.getElementById("bdb-post-reviews-table")&&(this.table=jQuery("#bdb-post-reviews-table"),this.postID=this.table.data("post-id"),this.userID=this.table.data("user-id"),this.tableBody=this.table.find("tbody"),this.errorWrap=jQuery("#bdb-post-reviews-errors"),this.searchResultsWrap=jQuery("#bdb-book-search-results"),this.getReviews(),jQuery("#bdb-associated-review-post").on("click",this.toggleSearch),jQuery("#bdb-search-book-title-author").on("keypress",this.searchBooks),jQuery("#bdb-search-book-fields").on("click","button",this.searchBooks),this.searchResultsWrap.on("click","a",this.selectBook),jQuery("#bdb-add-review").on("click",this.addReview),jQuery(document).on("click",".bdb-disassociate-review-from-post",this.disassociateReview),jQuery(document).on("click",".bdb-delete-review",this.deleteReview))},getReviews:function(){r("v1/reviews",{rating_format:"text",review_query:[{field:"post_id",value:s.postID}]},"GET").then((function(e){s.tableBody.empty(),0===e.length||void 0===e.length?s.tableBody.append(wp.template("bdb-table-post-reviews-row-empty")):jQuery.each(e,(function(e,t){s.tableBody.append(wp.template("bdb-table-post-reviews-row")(t))}))})).catch((function(e){s.errorWrap.empty().append(e).show()}))},toggleSearch:function(e){e.preventDefault(),jQuery("#bdb-search-book-fields").slideToggle()},searchBooks:function(n){if("click"===n.type&&n.preventDefault(),"keypress"===n.type&&13!==n.which)return!0;n.preventDefault();var a=jQuery("#bdb-search-book-fields").find("button"),i=jQuery("#bdb-search-book-title-author").val(),o=jQuery("#bdb-search-book-type").val(),d={};e(a),s.errorWrap.empty().hide(),s.searchResultsWrap.empty(),"author"===o?d.author_query=[{field:"name",value:i,operator:"LIKE"}]:d.book_query=[{field:"title",value:i,operator:"LIKE"}],r("v1/books",d,"GET").then((function(e){if(0===e.length||void 0===e.length)s.searchResultsWrap.append("<p>"+bdbVars.no_books+"</p>");else{var t="";jQuery.each(e,(function(e,r){t=t+'<li><a href="#" data-id="'+r.id+'">'+r.title+" "+bdbVars.by+" "+r.author_name+"</a></li>"})),s.searchResultsWrap.append("<ul>"+t+"</ul>")}})).catch((function(e){s.errorWrap.append(e).show()})).finally((function(){t(a)}))},selectBook:function(e){e.preventDefault(),s.bookID=jQuery(this).data("id"),s.searchResultsWrap.empty().append("<p>"+bdbVars.please_wait+"</p>"),r("v1/reading-log",{book_id:jQuery(this).data("id")},"GET").then((function(e){var t=jQuery("#bdb-review-reading-log");e.length>0&&(t.empty(),jQuery.each(e,(function(e,r){t.append('<option value="'+r.id+'">'+s.shapeLog(r)+"</option>")}))),s.searchResultsWrap.empty(),jQuery("#bdb-add-review-fields").show()})).catch((function(e){s.errorWrap.append(e).show()}))},shapeLog:function(e){return e.date_started_formatted=o(e.date_started,"display"),e.date_finished_formatted=o(e.date_finished,"display"),e.rating=null===e.rating?null:parseFloat(e.rating)+" "+bdbVars.stars,e.date_started_formatted||(e.date_started_formatted="("+bdbVars.unknown+")"),e.date_finished_formatted||(e.date_finished_formatted="("+bdbVars.unknown+")"),e.date_started_formatted+" - "+e.date_finished_formatted+" ("+e.rating+")"},addReview:function(n){n.preventDefault();var a=jQuery(this);e(a),r("v1/review/add",{book_id:s.bookID,reading_log_id:jQuery("#bdb-review-reading-log").val(),user_id:s.userID,post_id:s.postID},"POST").then((function(e){return r("v1/reviews",{rating_format:"text",review_query:[{field:"id",value:e.id}]},"GET")})).then((function(e){jQuery.each(e,(function(e,t){jQuery("#bdb-no-post-reviews").remove(),s.tableBody.append(wp.template("bdb-table-post-reviews-row")(t))})),jQuery("#bdb-add-review-fields").hide()})).catch((function(e){s.errorWrap.append(e).show()})).finally((function(){t(a)}))},disassociateReview:function(n){if(n.preventDefault(),!confirm(bdbVars.confirm_remove_review_association))return!1;var a=jQuery(this);e(a),s.errorWrap.empty().hide();var i=a.closest("tr");r("v1/review/update/"+i.data("id"),{post_id:null},"POST").then((function(e){i.remove()})).catch((function(e){s.errorWrap.append(e).show()})).finally((function(){t(a)}))},deleteReview:function(n){if(n.preventDefault(),!confirm(bdbVars.confirm_delete_review))return!1;var a=jQuery(this);e(a),s.errorWrap.empty().hide();var i=a.closest("tr");r("v1/review/delete/"+i.data("id"),{post_id:null},"DELETE").then((function(e){i.remove()})).catch((function(e){s.errorWrap.append(e).show()})).finally((function(){t(a)}))}};jQuery,n.init(),s.init()})();